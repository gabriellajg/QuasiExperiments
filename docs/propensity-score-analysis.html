<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Propensity Score Analysis | R Book for Quasi-Experimental Designs</title>
  <meta name="description" content="Chapter 6 Propensity Score Analysis | R Book for Quasi-Experimental Designs" />
  <meta name="generator" content="bookdown 0.28 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Propensity Score Analysis | R Book for Quasi-Experimental Designs" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Propensity Score Analysis | R Book for Quasi-Experimental Designs" />
  
  
  

<meta name="author" content="Ge Jiang" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="psm-matching-strategy.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R for Quasi-exp Designs</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Course</a></li>
<li class="chapter" data-level="2" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html"><i class="fa fa-check"></i><b>2</b> Regression Approach to Treatment Effect Estimation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html#regression-w-no-confounder"><i class="fa fa-check"></i><b>2.1</b> Regression w/ no confounder</a></li>
<li class="chapter" data-level="2.2" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html#including-confounder-ses"><i class="fa fa-check"></i><b>2.2</b> Including confounder SES</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html#low-ses"><i class="fa fa-check"></i><b>2.2.1</b> low SES</a></li>
<li class="chapter" data-level="2.2.2" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html#middle-ses"><i class="fa fa-check"></i><b>2.2.2</b> middle SES</a></li>
<li class="chapter" data-level="2.2.3" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html#high-ses"><i class="fa fa-check"></i><b>2.2.3</b> high SES</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="types-of-causal-effects.html"><a href="types-of-causal-effects.html"><i class="fa fa-check"></i><b>3</b> Types of Causal Effects</a>
<ul>
<li class="chapter" data-level="3.1" data-path="types-of-causal-effects.html"><a href="types-of-causal-effects.html#att-ate-atu-what-the-what"><i class="fa fa-check"></i><b>3.1</b> ATT, ATE, ATU, â€¦ what the what?</a></li>
<li class="chapter" data-level="3.2" data-path="types-of-causal-effects.html"><a href="types-of-causal-effects.html#calculating-different-causal-effects-in-practice"><i class="fa fa-check"></i><b>3.2</b> Calculating different causal effects in practice</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="instrumental-variable.html"><a href="instrumental-variable.html"><i class="fa fa-check"></i><b>4</b> Instrumental Variable</a>
<ul>
<li class="chapter" data-level="4.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#loading-data"><i class="fa fa-check"></i><b>4.1</b> Loading Data</a></li>
<li class="chapter" data-level="4.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#setup"><i class="fa fa-check"></i><b>4.2</b> Setup</a></li>
<li class="chapter" data-level="4.3" data-path="instrumental-variable.html"><a href="instrumental-variable.html#regression-approaches"><i class="fa fa-check"></i><b>4.3</b> Regression Approaches</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#naive-regression-ols-estimate-with-treatment-only"><i class="fa fa-check"></i><b>4.3.1</b> Naive Regression: OLS estimate with treatment only</a></li>
<li class="chapter" data-level="4.3.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#regression-with-covariates"><i class="fa fa-check"></i><b>4.3.2</b> Regression with covariates</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="instrumental-variable.html"><a href="instrumental-variable.html#iv-does-education-effect-wages-when-college-proximity-is-used-as-the-instrument"><i class="fa fa-check"></i><b>4.4</b> IV: Does education effect wages when college proximity is used as the instrument?</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#stage-1-t-on-iv"><i class="fa fa-check"></i><b>4.4.1</b> Stage 1: T on IV</a></li>
<li class="chapter" data-level="4.4.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#stage-2-y-on-t_hat"><i class="fa fa-check"></i><b>4.4.2</b> Stage 2: Y on T_hat</a></li>
<li class="chapter" data-level="4.4.3" data-path="instrumental-variable.html"><a href="instrumental-variable.html#all-in-one-function-ivreg"><i class="fa fa-check"></i><b>4.4.3</b> All-in-one function ivreg():</a></li>
<li class="chapter" data-level="4.4.4" data-path="instrumental-variable.html"><a href="instrumental-variable.html#diagnostic-tests"><i class="fa fa-check"></i><b>4.4.4</b> Diagnostic tests:</a></li>
<li class="chapter" data-level="4.4.5" data-path="instrumental-variable.html"><a href="instrumental-variable.html#multiple-iv"><i class="fa fa-check"></i><b>4.4.5</b> Multiple IV</a></li>
<li class="chapter" data-level="4.4.6" data-path="instrumental-variable.html"><a href="instrumental-variable.html#compare-with-ols"><i class="fa fa-check"></i><b>4.4.6</b> Compare with OLS:</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="instrumental-variable.html"><a href="instrumental-variable.html#take-home-exercise"><i class="fa fa-check"></i><b>4.5</b> Take-home exercise</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#does-cigarette-smoking-have-an-effect-on-child-birth-weight-wooldridge-2002"><i class="fa fa-check"></i><b>4.5.1</b> Does cigarette smoking have an effect on child birth weight (Wooldridge, 2002)?</a></li>
<li class="chapter" data-level="4.5.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#missing-data"><i class="fa fa-check"></i><b>4.5.2</b> Missing data</a></li>
<li class="chapter" data-level="4.5.3" data-path="instrumental-variable.html"><a href="instrumental-variable.html#your-turn-now"><i class="fa fa-check"></i><b>4.5.3</b> Your turn now!!!!</a></li>
<li class="chapter" data-level="4.5.4" data-path="instrumental-variable.html"><a href="instrumental-variable.html#naive-regression-ols-estimate-with-treatment-only-1"><i class="fa fa-check"></i><b>4.5.4</b> Naive Regression: OLS Estimate with treatment only</a></li>
<li class="chapter" data-level="4.5.5" data-path="instrumental-variable.html"><a href="instrumental-variable.html#regression-with-covariates-1"><i class="fa fa-check"></i><b>4.5.5</b> Regression with covariates</a></li>
<li class="chapter" data-level="4.5.6" data-path="instrumental-variable.html"><a href="instrumental-variable.html#iv-done-manually"><i class="fa fa-check"></i><b>4.5.6</b> IV done manually</a></li>
<li class="chapter" data-level="4.5.7" data-path="instrumental-variable.html"><a href="instrumental-variable.html#ivreg"><i class="fa fa-check"></i><b>4.5.7</b> IVreg()</a></li>
<li class="chapter" data-level="4.5.8" data-path="instrumental-variable.html"><a href="instrumental-variable.html#model-comparison"><i class="fa fa-check"></i><b>4.5.8</b> Model Comparison</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html"><i class="fa fa-check"></i><b>5</b> PSM Matching Strategy</a>
<ul>
<li class="chapter" data-level="5.1" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#data"><i class="fa fa-check"></i><b>5.1</b> Data</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#create-dummy-variable-for-race-and-unemployment"><i class="fa fa-check"></i><b>5.1.1</b> Create dummy variable for race and unemployment</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#regression-estimates"><i class="fa fa-check"></i><b>5.2</b> Regression Estimates</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#naive-t-test-estimate"><i class="fa fa-check"></i><b>5.2.1</b> naive t-test estimate</a></li>
<li class="chapter" data-level="5.2.2" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#regression-with-covariates-2"><i class="fa fa-check"></i><b>5.2.2</b> regression with covariates</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#psm-steps"><i class="fa fa-check"></i><b>5.3</b> PSM Steps</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#selection-of-covariates-in-x"><i class="fa fa-check"></i><b>5.3.1</b> Selection of covariates in X</a></li>
<li class="chapter" data-level="5.3.2" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#calculation-of-propensity-scores-p-scores"><i class="fa fa-check"></i><b>5.3.2</b> Calculation of propensity scores (p-scores)</a></li>
<li class="chapter" data-level="5.3.3" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#matching-based-on-p-sores"><i class="fa fa-check"></i><b>5.3.3</b> Matching based on p-sores</a></li>
<li class="chapter" data-level="5.3.4" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#checking-balance-on-covariates"><i class="fa fa-check"></i><b>5.3.4</b> Checking balance on covariates:</a></li>
<li class="chapter" data-level="5.3.5" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#estimation-of-treatment-effect"><i class="fa fa-check"></i><b>5.3.5</b> Estimation of treatment effect</a></li>
<li class="chapter" data-level="5.3.6" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#hidden-bias-analysis"><i class="fa fa-check"></i><b>5.3.6</b> Hidden bias analysis</a></li>
<li class="chapter" data-level="5.3.7" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#references"><i class="fa fa-check"></i><b>5.3.7</b> References:</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html"><i class="fa fa-check"></i><b>6</b> Propensity Score Analysis</a>
<ul>
<li class="chapter" data-level="6.1" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#data-1"><i class="fa fa-check"></i><b>6.1</b> Data</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#create-dummy-variable-for-race-and-unemployment-1"><i class="fa fa-check"></i><b>6.1.1</b> Create dummy variable for race and unemployment</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#calculating-propensity-scores"><i class="fa fa-check"></i><b>6.2</b> Calculating Propensity Scores</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#different-formulas"><i class="fa fa-check"></i><b>6.2.1</b> Different formulas</a></li>
<li class="chapter" data-level="6.2.2" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#calculation-of-propensity-scores-p-scores-1"><i class="fa fa-check"></i><b>6.2.2</b> Calculation of propensity scores (p-scores)</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#iptw-inverse-probability-treatment-weighting"><i class="fa fa-check"></i><b>6.3</b> IPTW: Inverse Probability Treatment Weighting</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#weightatt"><i class="fa fa-check"></i><b>6.3.1</b> weightATT</a></li>
<li class="chapter" data-level="6.3.2" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#weightate"><i class="fa fa-check"></i><b>6.3.2</b> weightATE</a></li>
<li class="chapter" data-level="6.3.3" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#weight-truncation"><i class="fa fa-check"></i><b>6.3.3</b> Weight truncation</a></li>
<li class="chapter" data-level="6.3.4" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#balance-check"><i class="fa fa-check"></i><b>6.3.4</b> Balance check</a></li>
<li class="chapter" data-level="6.3.5" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#estimation-of-treatment-effect-1"><i class="fa fa-check"></i><b>6.3.5</b> Estimation of treatment effect</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#stratification"><i class="fa fa-check"></i><b>6.4</b> Stratification</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#manually-creating-subclasses"><i class="fa fa-check"></i><b>6.4.1</b> Manually creating subclasses</a></li>
<li class="chapter" data-level="6.4.2" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#stratification-using-matchit"><i class="fa fa-check"></i><b>6.4.2</b> Stratification using matchit():</a></li>
<li class="chapter" data-level="6.4.3" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#covariate-balance-evaluation"><i class="fa fa-check"></i><b>6.4.3</b> Covariate Balance Evaluation</a></li>
<li class="chapter" data-level="6.4.4" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#calculate-the-stratum-weights"><i class="fa fa-check"></i><b>6.4.4</b> Calculate the stratum weights</a></li>
<li class="chapter" data-level="6.4.5" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#estimation-of-treatment-effects"><i class="fa fa-check"></i><b>6.4.5</b> Estimation of Treatment Effects</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#adjustment"><i class="fa fa-check"></i><b>6.5</b> Adjustment</a></li>
<li class="chapter" data-level="6.6" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#exercise"><i class="fa fa-check"></i><b>6.6</b> Exercise</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R Book for Quasi-Experimental Designs</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="propensity-score-analysis" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Chapter 6</span> Propensity Score Analysis<a href="propensity-score-analysis.html#propensity-score-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this lab, we will use propensity scores to perform other types of analyses (weighting, stratification, and covariate adjustment)</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="propensity-score-analysis.html#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(weights)</span>
<span id="cb151-2"><a href="propensity-score-analysis.html#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span>
<span id="cb151-3"><a href="propensity-score-analysis.html#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(twang)</span>
<span id="cb151-4"><a href="propensity-score-analysis.html#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CBPS)</span>
<span id="cb151-5"><a href="propensity-score-analysis.html#cb151-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cobalt)</span>
<span id="cb151-6"><a href="propensity-score-analysis.html#cb151-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jtools)</span>
<span id="cb151-7"><a href="propensity-score-analysis.html#cb151-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb151-8"><a href="propensity-score-analysis.html#cb151-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich) <span class="co">#vcovCL</span></span>
<span id="cb151-9"><a href="propensity-score-analysis.html#cb151-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rbounds) <span class="co">#gamma</span></span>
<span id="cb151-10"><a href="propensity-score-analysis.html#cb151-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb151-11"><a href="propensity-score-analysis.html#cb151-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb151-12"><a href="propensity-score-analysis.html#cb151-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb151-13"><a href="propensity-score-analysis.html#cb151-13" aria-hidden="true" tabindex="-1"></a><span class="co">#remotes::install_github(&quot;vdorie/treatSens&quot;)</span></span>
<span id="cb151-14"><a href="propensity-score-analysis.html#cb151-14" aria-hidden="true" tabindex="-1"></a><span class="co">#library(treatSens)</span></span></code></pre></div>
<!------------------------------>
<div id="data-1" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Data<a href="propensity-score-analysis.html#data-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="propensity-score-analysis.html#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co">#data(lalonde)</span></span>
<span id="cb152-2"><a href="propensity-score-analysis.html#cb152-2" aria-hidden="true" tabindex="-1"></a>lalonde <span class="ot">=</span> MatchIt<span class="sc">::</span>lalonde</span>
<span id="cb152-3"><a href="propensity-score-analysis.html#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(lalonde)</span></code></pre></div>
<pre><code>## [1] 614   9</code></pre>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="propensity-score-analysis.html#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(lalonde)</span></code></pre></div>
<pre><code>## [1] &quot;treat&quot;    &quot;age&quot;      &quot;educ&quot;     &quot;race&quot;     &quot;married&quot;  &quot;nodegree&quot; &quot;re74&quot;    
## [8] &quot;re75&quot;     &quot;re78&quot;</code></pre>
<div id="create-dummy-variable-for-race-and-unemployment-1" class="section level3 hasAnchor" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Create dummy variable for race and unemployment<a href="propensity-score-analysis.html#create-dummy-variable-for-race-and-unemployment-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="propensity-score-analysis.html#cb156-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>black <span class="ot">=</span> <span class="fu">ifelse</span>(lalonde<span class="sc">$</span>race<span class="sc">==</span><span class="st">&#39;black&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb156-2"><a href="propensity-score-analysis.html#cb156-2" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>hispan <span class="ot">=</span> <span class="fu">ifelse</span>(lalonde<span class="sc">$</span>race<span class="sc">==</span><span class="st">&#39;hispan&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb156-3"><a href="propensity-score-analysis.html#cb156-3" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>un74 <span class="ot">=</span> <span class="fu">ifelse</span>(lalonde<span class="sc">$</span>re74<span class="sc">==</span><span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb156-4"><a href="propensity-score-analysis.html#cb156-4" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>un75 <span class="ot">=</span> <span class="fu">ifelse</span>(lalonde<span class="sc">$</span>re75<span class="sc">==</span><span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span></code></pre></div>
<!------------------------------>
</div>
</div>
<div id="calculating-propensity-scores" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Calculating Propensity Scores<a href="propensity-score-analysis.html#calculating-propensity-scores" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<div id="different-formulas" class="section level3 hasAnchor" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Different formulas<a href="propensity-score-analysis.html#different-formulas" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="propensity-score-analysis.html#cb157-1" aria-hidden="true" tabindex="-1"></a>fm1 <span class="ot">=</span> treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispan <span class="sc">+</span> married <span class="sc">+</span> <span class="fu">I</span>(re74<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">+</span> <span class="fu">I</span>(re75<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb157-2"><a href="propensity-score-analysis.html#cb157-2" aria-hidden="true" tabindex="-1"></a>fm2 <span class="ot">=</span> treat <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispan <span class="sc">+</span> married <span class="sc">+</span> <span class="fu">I</span>(re74<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">+</span> <span class="fu">I</span>(re75<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb157-3"><a href="propensity-score-analysis.html#cb157-3" aria-hidden="true" tabindex="-1"></a>fm3 <span class="ot">=</span> treat <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> educ <span class="sc">+</span> <span class="fu">I</span>(educ<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> black <span class="sc">+</span> hispan <span class="sc">+</span> married <span class="sc">+</span> <span class="fu">I</span>(re74<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">+</span> <span class="fu">I</span>(re75<span class="sc">/</span><span class="dv">1000</span>)</span></code></pre></div>
</div>
<div id="calculation-of-propensity-scores-p-scores-1" class="section level3 hasAnchor" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Calculation of propensity scores (p-scores)<a href="propensity-score-analysis.html#calculation-of-propensity-scores-p-scores-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="propensity-score-analysis.html#cb158-1" aria-hidden="true" tabindex="-1"></a>pscore <span class="ot">&lt;-</span> <span class="fu">glm</span>(fm3, <span class="at">data =</span> lalonde, <span class="at">family =</span> <span class="st">&#39;binomial&#39;</span>)</span>
<span id="cb158-2"><a href="propensity-score-analysis.html#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pscore<span class="sc">$</span>fitted.values)</span></code></pre></div>
<pre><code>##      NSW1      NSW2      NSW3      NSW4      NSW5      NSW6 
## 0.6664569 0.3896185 0.9237414 0.9345017 0.9434150 0.8771158</code></pre>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="propensity-score-analysis.html#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(pscore<span class="sc">$</span>fitted.values[lalonde<span class="sc">$</span>treat<span class="sc">==</span><span class="dv">0</span>],<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb160-2"><a href="propensity-score-analysis.html#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(pscore<span class="sc">$</span>fitted.values[lalonde<span class="sc">$</span>treat<span class="sc">==</span><span class="dv">1</span>],<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">add=</span>T)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-282-1.png" width="672" /></p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="propensity-score-analysis.html#cb161-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>pscore <span class="ot">=</span> pscore<span class="sc">$</span>fitted.values</span></code></pre></div>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="propensity-score-analysis.html#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(pscore<span class="sc">$</span>fitted.values[lalonde<span class="sc">$</span>treat<span class="sc">==</span><span class="dv">0</span>],<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">density =</span> <span class="dv">20</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">main=</span><span class="st">&quot;Propensity Scores&quot;</span>, <span class="at">xlab=</span><span class="st">&quot;Shaded = Untreated | Gray = Treated&quot;</span>)</span>
<span id="cb162-2"><a href="propensity-score-analysis.html#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(pscore<span class="sc">$</span>fitted.values[lalonde<span class="sc">$</span>treat<span class="sc">==</span><span class="dv">1</span>],<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">col=</span><span class="fu">gray</span>(<span class="fl">0.4</span>,<span class="fl">0.25</span>),<span class="at">add=</span>T)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-283-1.png" width="672" /></p>
<!------------------------------>
</div>
</div>
<div id="iptw-inverse-probability-treatment-weighting" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> IPTW: Inverse Probability Treatment Weighting<a href="propensity-score-analysis.html#iptw-inverse-probability-treatment-weighting" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<div id="weightatt" class="section level3 hasAnchor" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> weightATT<a href="propensity-score-analysis.html#weightatt" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>weightATT is created by using the ifelse() function to obtain:
* 1 for treated units
* p/(1-p) for control units</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="propensity-score-analysis.html#cb163-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>weightATT <span class="ot">&lt;-</span> <span class="fu">with</span>(lalonde, <span class="fu">ifelse</span>(treat<span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span>, pscore<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pscore)))</span></code></pre></div>
<p>A summary of the ATT weights for treated and untreated groups:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="propensity-score-analysis.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(lalonde, <span class="fu">by</span>(weightATT,treat,summary)) </span></code></pre></div>
<pre><code>## treat: 0
##      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
##  0.000049  0.024790  0.065181  0.444293  0.193012 16.909853 
## ----------------------------------------------------------------- 
## treat: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##       1       1       1       1       1       1</code></pre>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="propensity-score-analysis.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(lalonde<span class="sc">$</span>weightATT <span class="sc">~</span> lalonde<span class="sc">$</span>treat)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-285-1.png" width="672" /></p>
</div>
<div id="weightate" class="section level3 hasAnchor" number="6.3.2">
<h3><span class="header-section-number">6.3.2</span> weightATE<a href="propensity-score-analysis.html#weightate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>weightATE is created by using the ifelse() function to obtain:
* 1/p for treated units
* 1/(1-p) for control units</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="propensity-score-analysis.html#cb167-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>weightATE <span class="ot">&lt;-</span> <span class="fu">with</span>(lalonde, <span class="fu">ifelse</span>(treat<span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>pscore, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pscore)))</span></code></pre></div>
<p>A summary of the ATE weights for treated and untreated groups:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="propensity-score-analysis.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(lalonde, <span class="fu">by</span>(weightATE,treat,summary)) </span></code></pre></div>
<pre><code>## treat: 0
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.000   1.025   1.065   1.444   1.193  17.910 
## ----------------------------------------------------------------- 
## treat: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.047   1.139   1.437   3.015   2.100  38.703</code></pre>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="propensity-score-analysis.html#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(lalonde<span class="sc">$</span>weightATE <span class="sc">~</span> lalonde<span class="sc">$</span>treat)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-287-1.png" width="672" /></p>
<ul>
<li>the maximum weight for the ATE is 33.961</li>
</ul>
</div>
<div id="weight-truncation" class="section level3 hasAnchor" number="6.3.3">
<h3><span class="header-section-number">6.3.3</span> Weight truncation<a href="propensity-score-analysis.html#weight-truncation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><p>Truncation can be performed by assigning the weight at a cutoff percentile to observations with weights above the cutoff.</p></li>
<li><p>The following code demonstrates weight truncation. More specifically, it uses the quantile function to calculate the weight at the 99th percentile and the ifelse function to assign this weight to any student whose weight exceeds the 99th percentile:</p></li>
</ul>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="propensity-score-analysis.html#cb171-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>weightATETruncated <span class="ot">&lt;-</span> <span class="fu">with</span>(lalonde, <span class="fu">ifelse</span>(weightATE <span class="sc">&gt;</span> <span class="fu">quantile</span>(weightATE, <span class="fl">0.99</span>), <span class="fu">quantile</span>(weightATE, <span class="fl">0.99</span>), weightATE))</span></code></pre></div>
<p>may truncate all above .05 quantiles if necessary</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="propensity-score-analysis.html#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(lalonde, <span class="fu">by</span>(weightATETruncated,treat,summary)) </span></code></pre></div>
<pre><code>## treat: 0
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.000   1.025   1.065   1.440   1.193  15.888 
## ----------------------------------------------------------------- 
## treat: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.047   1.139   1.437   2.571   2.100  15.888</code></pre>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="propensity-score-analysis.html#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(lalonde<span class="sc">$</span>weightATETruncated <span class="sc">~</span> lalonde<span class="sc">$</span>treat)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-289-1.png" width="672" /></p>
</div>
<div id="balance-check" class="section level3 hasAnchor" number="6.3.4">
<h3><span class="header-section-number">6.3.4</span> Balance check<a href="propensity-score-analysis.html#balance-check" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In this section, covariate balance evaluation is performed by comparing the standardized difference between the weighted means of the treated and untreated groups.</p>
<p>The bal.stat function of the twang package (Ridgeway et al., 2013) is useful for covariate balance evaluation.</p>
<p>If there are no sampling weights, then sampw=1.</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="propensity-score-analysis.html#cb175-1" aria-hidden="true" tabindex="-1"></a>covariateNames <span class="ot">&lt;-</span><span class="fu">names</span>(lalonde)[<span class="dv">2</span><span class="sc">:</span><span class="dv">14</span>]</span>
<span id="cb175-2"><a href="propensity-score-analysis.html#cb175-2" aria-hidden="true" tabindex="-1"></a>balanceTable <span class="ot">&lt;-</span> <span class="fu">bal.stat</span>(lalonde, <span class="at">vars=</span> covariateNames,</span>
<span id="cb175-3"><a href="propensity-score-analysis.html#cb175-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">treat.var =</span> <span class="st">&quot;treat&quot;</span>,</span>
<span id="cb175-4"><a href="propensity-score-analysis.html#cb175-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">w.all =</span> lalonde<span class="sc">$</span>weightATT, </span>
<span id="cb175-5"><a href="propensity-score-analysis.html#cb175-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">get.ks=</span>F,</span>
<span id="cb175-6"><a href="propensity-score-analysis.html#cb175-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">sampw =</span> <span class="dv">1</span>,</span>
<span id="cb175-7"><a href="propensity-score-analysis.html#cb175-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">estimand=</span><span class="st">&quot;ATT&quot;</span>, <span class="at">multinom=</span>F)</span>
<span id="cb175-8"><a href="propensity-score-analysis.html#cb175-8" aria-hidden="true" tabindex="-1"></a>balanceTable <span class="ot">&lt;-</span> balanceTable<span class="sc">$</span>results</span>
<span id="cb175-9"><a href="propensity-score-analysis.html#cb175-9" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(balanceTable,<span class="dv">3</span>) </span></code></pre></div>
<pre><code>##                tx.mn    tx.sd    ct.mn    ct.sd std.eff.sz   stat     p
## age           25.816    7.155   26.346    7.490     -0.074 -0.472 0.637
## educ          10.346    2.011   10.521    1.948     -0.087 -0.610 0.542
## race:black     0.843    0.364    0.852    0.355     -0.025  0.062 0.932
## race:hispan    0.059    0.236    0.060    0.238     -0.003     NA    NA
## race:white     0.097    0.296    0.087    0.282      0.033     NA    NA
## married        0.189    0.393    0.156    0.363      0.085  0.739 0.460
## nodegree       0.708    0.456    0.581    0.494      0.279  1.491 0.136
## re74        2095.574 4886.620 1884.933 3730.334      0.043  0.394 0.694
## re75        1532.055 3219.251 1346.461 2543.044      0.058  0.538 0.590
## re78        6349.144 7867.402 4785.768 5508.068      0.199  1.752 0.080
## black          0.843    0.365    0.852    0.355     -0.025 -0.239 0.811
## hispan         0.059    0.237    0.060    0.238     -0.003 -0.032 0.974
## un74           0.708    0.456    0.505    0.501      0.445  2.351 0.019
## un75           0.600    0.491    0.511    0.500      0.180  1.017 0.310
## pscore         0.643    0.264    0.654    0.266     -0.040 -0.242 0.809</code></pre>
<ul>
<li>std.eff.sz quantifies effect size</li>
<li>0.2 small 0.5 medium 0.8 large</li>
<li>most of them are small (except nodegree and un74) - balance was somewhat achieved *</li>
</ul>
</div>
<div id="estimation-of-treatment-effect-1" class="section level3 hasAnchor" number="6.3.5">
<h3><span class="header-section-number">6.3.5</span> Estimation of treatment effect<a href="propensity-score-analysis.html#estimation-of-treatment-effect-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>the final weights are divided by the mean of weights to make them sum to the sample size, which is a process known as normalization.</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="propensity-score-analysis.html#cb177-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>finalWeight <span class="ot">&lt;-</span> lalonde<span class="sc">$</span>weightATT<span class="sc">/</span><span class="fu">mean</span>(lalonde<span class="sc">$</span>weightATT)</span></code></pre></div>
<p>Before the estimation can be performed, the surveyDesign object is created with the svydesign function to declare the names of the variables that contain cluster ids, strata ids, weights, and the data set:</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="propensity-score-analysis.html#cb178-1" aria-hidden="true" tabindex="-1"></a>surveyDesign <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>finalWeight, <span class="at">data =</span> lalonde, <span class="at">nest=</span>T) </span></code></pre></div>
<p>Methods to obtain standard errors for propensity score weighted estimates include Taylor series linearization and resampling methods such as bootstrapping, jackknife, and balanced repeated replication (see review by Rodgers, 1999).</p>
<p>To use bootstrap methods with the survey package, the surveyDesign object created above should be modified to include weights for each replication. The following code takes the surveyDesign object and adds weights for 1,000 bootstrapped samples:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="propensity-score-analysis.html#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">8</span>)</span>
<span id="cb179-2"><a href="propensity-score-analysis.html#cb179-2" aria-hidden="true" tabindex="-1"></a>surveyDesignBoot <span class="ot">&lt;-</span> <span class="fu">as.svrepdesign</span>(surveyDesign, <span class="at">type=</span><span class="fu">c</span>(<span class="st">&quot;bootstrap&quot;</span>), <span class="at">replicates=</span><span class="dv">1000</span>)</span></code></pre></div>
<p>First, the svyby function is used to apply the svymean function separately to treated and control units to obtain weighted outcome:</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="propensity-score-analysis.html#cb180-1" aria-hidden="true" tabindex="-1"></a>weightedMeans <span class="ot">&lt;-</span> <span class="fu">svyby</span>(<span class="at">formula=</span><span class="sc">~</span>re78, <span class="at">by=</span><span class="sc">~</span>treat, <span class="at">design=</span>surveyDesignBoot, <span class="at">FUN=</span>svymean, <span class="at">covmat=</span><span class="cn">TRUE</span>)</span>
<span id="cb180-2"><a href="propensity-score-analysis.html#cb180-2" aria-hidden="true" tabindex="-1"></a>weightedMeans</span></code></pre></div>
<pre><code>##   treat     re78       se
## 0     0 4785.768 682.1430
## 1     1 6349.144 574.9245</code></pre>
<p><em>The code to obtain the treatment effect with a regression model is shown as follows.
</em> The model formula using R notation is re78~treat. This formula can be expanded to include any covariates and interaction effects of interest</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="propensity-score-analysis.html#cb182-1" aria-hidden="true" tabindex="-1"></a>outcomeModel <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(re78<span class="sc">~</span>treat, <span class="at">design =</span> surveyDesignBoot)</span>
<span id="cb182-2"><a href="propensity-score-analysis.html#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(outcomeModel)</span></code></pre></div>
<pre><code>## 
## Call:
## svyglm(formula = re78 ~ treat, design = surveyDesignBoot)
## 
## Survey design:
## as.svrepdesign.default(surveyDesign, type = c(&quot;bootstrap&quot;), replicates = 1000)
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   4785.8      682.1   7.016 6.08e-12 ***
## treat         1563.4      880.1   1.776   0.0762 .  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for gaussian family taken to be 28048383050)
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<p>Double robust with the imbalanced covariates:</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="propensity-score-analysis.html#cb184-1" aria-hidden="true" tabindex="-1"></a>outcomeModel <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(re78 <span class="sc">~</span> treat <span class="sc">+</span> nodegree <span class="sc">+</span> un74, <span class="at">design =</span> surveyDesignBoot)</span>
<span id="cb184-2"><a href="propensity-score-analysis.html#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(outcomeModel)</span></code></pre></div>
<pre><code>## 
## Call:
## svyglm(formula = re78 ~ treat + nodegree + un74, design = surveyDesignBoot)
## 
## Survey design:
## as.svrepdesign.default(surveyDesign, type = c(&quot;bootstrap&quot;), replicates = 1000)
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   5232.5      976.2   5.360 1.18e-07 ***
## treat         1600.5      956.3   1.674   0.0947 .  
## nodegree     -1336.3     1054.2  -1.268   0.2054    
## un74           653.1      910.9   0.717   0.4737    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for gaussian family taken to be 27760905000)
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<!------------------------------>
</div>
</div>
<div id="stratification" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Stratification<a href="propensity-score-analysis.html#stratification" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<div id="manually-creating-subclasses" class="section level3 hasAnchor" number="6.4.1">
<h3><span class="header-section-number">6.4.1</span> Manually creating subclasses<a href="propensity-score-analysis.html#manually-creating-subclasses" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li>The following code used the cut function to create five strata of approximately the same size based on the quintiles of the distribution of propensity scores for both treated and untreated groups.</li>
<li>The quintiles are obtained with the quantile function. The function levels is used to assign number labels from 1 to 5 to the strata, and then xtabs is used to display strata by treatment counts.</li>
<li>The number of strata is limited by the common support of the propensity score distributions of treated and untreated groups, because each stratum must have at least one treated and one untreated observation.</li>
</ul>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="propensity-score-analysis.html#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(lalonde<span class="sc">$</span>pscore)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-297-1.png" width="672" /></p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="propensity-score-analysis.html#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(lalonde<span class="sc">$</span>pscore, <span class="at">prob =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span>))</span></code></pre></div>
<pre><code>##           0%          20%          40%          60%          80%         100% 
## 4.922848e-05 2.608815e-02 7.289915e-02 2.419414e-01 6.698725e-01 9.546820e-01</code></pre>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="propensity-score-analysis.html#cb189-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>subclass <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="at">x=</span>lalonde<span class="sc">$</span>pscore, <span class="at">breaks =</span> <span class="fu">quantile</span>(lalonde<span class="sc">$</span>pscore, <span class="at">prob =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span>)), <span class="at">include.lowest=</span>T)</span>
<span id="cb189-2"><a href="propensity-score-analysis.html#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(lalonde<span class="sc">$</span>subclass) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">levels</span>(lalonde<span class="sc">$</span>subclass))</span>
<span id="cb189-3"><a href="propensity-score-analysis.html#cb189-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-4"><a href="propensity-score-analysis.html#cb189-4" aria-hidden="true" tabindex="-1"></a>ntable <span class="ot">&lt;-</span> <span class="fu">xtabs</span>(<span class="sc">~</span>treat<span class="sc">+</span>subclass,lalonde) </span>
<span id="cb189-5"><a href="propensity-score-analysis.html#cb189-5" aria-hidden="true" tabindex="-1"></a>ntable</span></code></pre></div>
<pre><code>##      subclass
## treat   1   2   3   4   5
##     0 122 118 106  61  22
##     1   1   5  16  62 101</code></pre>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="propensity-score-analysis.html#cb191-1" aria-hidden="true" tabindex="-1"></a>surveyDesign <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>lalonde<span class="sc">$</span>finalWeight, </span>
<span id="cb191-2"><a href="propensity-score-analysis.html#cb191-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> lalonde, <span class="at">nest=</span>T) </span></code></pre></div>
</div>
<div id="stratification-using-matchit" class="section level3 hasAnchor" number="6.4.2">
<h3><span class="header-section-number">6.4.2</span> Stratification using matchit():<a href="propensity-score-analysis.html#stratification-using-matchit" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="propensity-score-analysis.html#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb192-2"><a href="propensity-score-analysis.html#cb192-2" aria-hidden="true" tabindex="-1"></a>stratification <span class="ot">&lt;-</span> <span class="fu">matchit</span>(<span class="at">data =</span> lalonde,</span>
<span id="cb192-3"><a href="propensity-score-analysis.html#cb192-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">formula =</span> fm2,</span>
<span id="cb192-4"><a href="propensity-score-analysis.html#cb192-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">distance =</span> <span class="st">&quot;logit&quot;</span>,</span>
<span id="cb192-5"><a href="propensity-score-analysis.html#cb192-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">&quot;subclass&quot;</span>,</span>
<span id="cb192-6"><a href="propensity-score-analysis.html#cb192-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">subclass =</span> <span class="dv">5</span>)</span></code></pre></div>
</div>
<div id="covariate-balance-evaluation" class="section level3 hasAnchor" number="6.4.3">
<h3><span class="header-section-number">6.4.3</span> Covariate Balance Evaluation<a href="propensity-score-analysis.html#covariate-balance-evaluation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="propensity-score-analysis.html#cb193-1" aria-hidden="true" tabindex="-1"></a>balance.stratification <span class="ot">=</span> <span class="fu">summary</span>(stratification)</span>
<span id="cb193-2"><a href="propensity-score-analysis.html#cb193-2" aria-hidden="true" tabindex="-1"></a>balance.stratification<span class="sc">$</span>qn</span></code></pre></div>
<pre><code>##           1  2  3  4  5 All
## Control 364 35 14 11  5 429
## Treated  35 39 37 37 37 185
## Total   399 74 51 48 42 614</code></pre>
<ul>
<li><p>It is noticeable in the cross-classification of treatment by strata shown above that the stratification based on the propensity scores of the treated resulted in a similar number of treated units within strata.</p></li>
<li><p>When using summary(), the default is to display balance only in aggregate using the subclassification weights. This balance output looks similar to that for other matching methods.</p></li>
</ul>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="propensity-score-analysis.html#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(balance.stratification<span class="sc">$</span>sum.across,<span class="dv">3</span>)</span></code></pre></div>
<pre><code>##                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
## distance               0.624         0.593           0.121      0.803     0.047
## age                   25.816        25.865          -0.007      0.811     0.030
## `I(age^2)`           717.395       731.133          -0.032      0.797     0.030
## `I(age^3)`         21554.659     22635.660          -0.052      0.751     0.030
## educ                  10.346        10.386          -0.020      0.389     0.045
## black                  0.843         0.811           0.088         NA     0.032
## hispan                 0.059         0.043           0.071         NA     0.017
## married                0.189         0.212          -0.058         NA     0.023
## `I(re74/1000)`         2.096         2.585          -0.100      0.953     0.047
## `I(re75/1000)`         1.532         1.542          -0.003      1.311     0.024
##                eCDF Max Std. Pair Dist.
## distance          0.098              NA
## age               0.112              NA
## `I(age^2)`        0.112              NA
## `I(age^3)`        0.112              NA
## educ              0.178              NA
## black             0.032              NA
## hispan            0.017              NA
## married           0.023              NA
## `I(re74/1000)`    0.252              NA
## `I(re75/1000)`    0.101              NA</code></pre>
<ul>
<li><p>If the goal is to estimate the treatment effect by pooling stratum-specific treatment effects, covariate balance should be evaluated and achieved within strata. * However, if the number of covariates is large, evaluation of covariate balance within strata can become cumbersome.</p></li>
<li><p>Also, if the sample sizes of treated or untreated groups within strata are small, covariate balance evaluation can become very sensitive to outliers.</p></li>
<li><p>An additional option in summary(), subclass, allows us to request balance for individual subclasses.</p></li>
<li><p>Below we call summary() and request balance to be displayed on all subclasses (setting un = FALSE to suppress balance in the original sample):</p></li>
</ul>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="propensity-score-analysis.html#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(stratification, <span class="at">subclass =</span> <span class="cn">TRUE</span>, <span class="at">un =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## 
## Call:
## matchit(formula = fm2, data = lalonde, method = &quot;subclass&quot;, distance = &quot;logit&quot;, 
##     subclass = 5)
## 
## Summary of Balance by Subclass:
## 
## - Subclass 1
##                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
## distance              0.1939        0.0801          0.4443     1.9143    0.3036
## age                  26.5714       28.8626         -0.3202     0.6086    0.0736
## `I(age^2)`          779.3143      956.6593         -0.4112     0.5202    0.0736
## `I(age^3)`        25222.1143    35807.3242         -0.5049     0.4174    0.0736
## educ                 10.5143       10.2170          0.1478     0.5463    0.0284
## black                 0.2571        0.0659          0.5259          .    0.1912
## hispan                0.2286        0.1621          0.2811          .    0.0665
## married               0.3714        0.5742         -0.5177          .    0.2027
## `I(re74/1000)`        3.9016        6.2471         -0.4800     1.1744    0.1693
## `I(re75/1000)`        2.1251        2.6298         -0.1568     0.9425    0.0761
##                eCDF Max
## distance         0.5192
## age              0.1527
## `I(age^2)`       0.1527
## `I(age^3)`       0.1527
## educ             0.0940
## black            0.1912
## hispan           0.0665
## married          0.2027
## `I(re74/1000)`   0.3720
## `I(re75/1000)`   0.1890
## 
## - Subclass 2
##                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
## distance              0.5145        0.5169         -0.0093     1.0639    0.0412
## age                  23.9231       21.6857          0.3127     1.6826    0.0757
## `I(age^2)`          658.7949      521.5143          0.3183     1.8594    0.0757
## `I(age^3)`        20941.4615    14232.2571          0.3200     2.0927    0.0757
## educ                  9.3846        9.9143         -0.2634     0.4968    0.0546
## black                 0.9231        0.9429         -0.0544          .    0.0198
## hispan                0.0769        0.0571          0.0836          .    0.0198
## married               0.2308        0.2000          0.0786          .    0.0308
## `I(re74/1000)`        2.3422        2.0878          0.0521     1.9796    0.0920
## `I(re75/1000)`        2.5483        1.5986          0.2950     3.2557    0.0886
##                eCDF Max
## distance         0.1443
## age              0.1619
## `I(age^2)`       0.1619
## `I(age^3)`       0.1619
## educ             0.2549
## black            0.0198
## hispan           0.0198
## married          0.0308
## `I(re74/1000)`   0.2894
## `I(re75/1000)`   0.2381
## 
## - Subclass 3
##                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
## distance              0.6695        0.6605          0.0351     1.2277    0.0945
## age                  25.0541       23.0714          0.2771     1.8144    0.0760
## `I(age^2)`          679.1622      559.3571          0.2778     2.6006    0.0760
## `I(age^3)`        20134.6216    14283.3571          0.2791     3.9868    0.0760
## educ                 10.8378       11.2857         -0.2228     0.2867    0.0731
## black                 1.0000        1.0000          0.0000          .    0.0000
## hispan                0.0000        0.0000          0.0000          .    0.0000
## married               0.3243        0.2143          0.2810          .    0.1100
## `I(re74/1000)`        2.2776        3.7009         -0.2913     0.4103    0.0866
## `I(re75/1000)`        1.2027        2.5788         -0.4275     0.1933    0.1333
##                eCDF Max
## distance         0.1931
## age              0.2375
## `I(age^2)`       0.2375
## `I(age^3)`       0.2375
## educ             0.3456
## black            0.0000
## hispan           0.0000
## married          0.1100
## `I(re74/1000)`   0.2375
## `I(re75/1000)`   0.3031
## 
## - Subclass 4
##                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
## distance              0.8194        0.7872          0.1256     0.8049    0.1987
## age                  25.9730       26.0909         -0.0165     0.6325    0.0880
## `I(age^2)`          704.1892      724.4545         -0.0470     0.6692    0.0880
## `I(age^3)`        20057.2162    21441.1818         -0.0660     0.7053    0.0880
## educ                 10.8108       10.7273          0.0415     0.4211    0.0781
## black                 1.0000        1.0000          0.0000          .    0.0000
## hispan                0.0000        0.0000          0.0000          .    0.0000
## married               0.0270        0.0909         -0.1631          .    0.0639
## `I(re74/1000)`        1.9019        1.0422          0.1759     3.4387    0.0793
## `I(re75/1000)`        0.9004        0.6699          0.0716     1.9497    0.0662
##                eCDF Max
## distance         0.3735
## age              0.2285
## `I(age^2)`       0.2285
## `I(age^3)`       0.2285
## educ             0.2187
## black            0.0000
## hispan           0.0000
## married          0.0639
## `I(re74/1000)`   0.2482
## `I(re75/1000)`   0.1351
## 
## - Subclass 5
##                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
## distance              0.9037        0.8952          0.0333     2.0591    0.2208
## age                  27.7027       30.0000         -0.3211     0.2193    0.2015
## `I(age^2)`          772.0270      917.2000         -0.3366     0.1871    0.2015
## `I(age^3)`        21649.2703    28580.4000         -0.3306     0.1596    0.2015
## educ                 10.2432        9.8000          0.2204     0.2171    0.1120
## black                 1.0000        1.0000          0.0000          .    0.0000
## hispan                0.0000        0.0000          0.0000          .    0.0000
## married               0.0000        0.0000          0.0000          .    0.0000
## `I(re74/1000)`        0.1388        0.0697          0.0141    10.1413    0.0562
## `I(re75/1000)`        0.8609        0.2897          0.1774     8.8591    0.0752
##                eCDF Max
## distance         0.4486
## age              0.4000
## `I(age^2)`       0.4000
## `I(age^3)`       0.4000
## educ             0.3838
## black            0.0000
## hispan           0.0000
## married          0.0000
## `I(re74/1000)`   0.1189
## `I(re75/1000)`   0.1892
## 
## Sample Sizes by Subclass:
##           1  2  3  4  5 All
## Control 364 35 14 11  5 429
## Treated  35 39 37 37 37 185
## Total   399 74 51 48 42 614</code></pre>
<ul>
<li>We can plot the standardized mean differences in a Love plot that also displays balance for the subclasses using plot.summary.matchit() on a summary.matchit() object with subclass = TRUE.</li>
</ul>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="propensity-score-analysis.html#cb199-1" aria-hidden="true" tabindex="-1"></a>balance.stratification2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(stratification, <span class="at">subclass =</span> <span class="cn">TRUE</span>)</span>
<span id="cb199-2"><a href="propensity-score-analysis.html#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(balance.stratification2, <span class="at">var.order =</span> <span class="st">&quot;unmatched&quot;</span>, <span class="at">abs =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-302-1.png" width="672" /></p>
<ul>
<li>Note that for some variables, while the groups are balanced in aggregate (black dots), the individual subclasses (gray numbers) may not be balanced, in which case unadjusted effect estimates within these subclasses should not be interpreted as unbiased.</li>
</ul>
</div>
<div id="calculate-the-stratum-weights" class="section level3 hasAnchor" number="6.4.4">
<h3><span class="header-section-number">6.4.4</span> Calculate the stratum weights<a href="propensity-score-analysis.html#calculate-the-stratum-weights" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To use bootstrap methods with the survey package, the surveyDesign object created above should be modified to include weights for each replication. The following code takes the surveyDesign object and adds weights for 1,000 bootstrapped samples:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="propensity-score-analysis.html#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">8</span>)</span>
<span id="cb200-2"><a href="propensity-score-analysis.html#cb200-2" aria-hidden="true" tabindex="-1"></a>surveyDesignBoot <span class="ot">&lt;-</span> <span class="fu">as.svrepdesign</span>(surveyDesign, <span class="at">type=</span><span class="fu">c</span>(<span class="st">&quot;bootstrap&quot;</span>), <span class="at">replicates=</span><span class="dv">1000</span>) </span></code></pre></div>
<p>The following R code uses svyby to apply the svymean function:</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="propensity-score-analysis.html#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(lalonde)</span></code></pre></div>
<pre><code>##      treat age educ   race married nodegree re74 re75       re78 black hispan un74
## NSW1     1  37   11  black       1        1    0    0  9930.0460     1      0    1
## NSW2     1  22    9 hispan       0        1    0    0  3595.8940     0      1    1
## NSW3     1  30   12  black       0        0    0    0 24909.4500     1      0    1
## NSW4     1  27   11  black       0        1    0    0  7506.1460     1      0    1
## NSW5     1  33    8  black       0        1    0    0   289.7899     1      0    1
## NSW6     1  22    9  black       0        1    0    0  4056.4940     1      0    1
##      un75    pscore weightATT weightATE weightATETruncated finalWeight subclass
## NSW1    1 0.6664569         1  1.500472           1.500472     1.63471        4
## NSW2    1 0.3896185         1  2.566613           2.566613     1.63471        4
## NSW3    1 0.9237414         1  1.082554           1.082554     1.63471        5
## NSW4    1 0.9345017         1  1.070089           1.070089     1.63471        5
## NSW5    1 0.9434150         1  1.059979           1.059979     1.63471        5
## NSW6    1 0.8771158         1  1.140100           1.140100     1.63471        5</code></pre>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="propensity-score-analysis.html#cb203-1" aria-hidden="true" tabindex="-1"></a>subclassMeans <span class="ot">&lt;-</span> <span class="fu">svyby</span>(<span class="at">formula=</span><span class="sc">~</span>re78, <span class="at">by=</span><span class="sc">~</span>treat<span class="sc">+</span>subclass,</span>
<span id="cb203-2"><a href="propensity-score-analysis.html#cb203-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">design=</span>surveyDesignBoot, <span class="at">FUN=</span>svymean, <span class="at">covmat=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## Warning in svrVar(repmeans, scale, rscales, mse = design$mse, coef = rval): 350
## replicates gave NA results and were discarded.</code></pre>
<pre><code>## Warning in svrVar(repmeans, scale, rscales, mse = design$mse, coef = rval): 5
## replicates gave NA results and were discarded.</code></pre>
<pre><code>## Warning in svrVar(replicates, design$scale, design$rscales, mse = design$mse, : 354
## replicates gave NA results and were discarded.</code></pre>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="propensity-score-analysis.html#cb207-1" aria-hidden="true" tabindex="-1"></a>subclassMeans</span></code></pre></div>
<pre><code>##     treat subclass     re78           se
## 0.1     0        1 7274.091 7.071227e+02
## 1.1     1        1 6788.463 4.072737e-14
## 0.2     0        2 6493.432 6.533589e+02
## 1.2     1        2 9781.223 6.981055e+03
## 0.3     0        3 6258.723 7.261635e+02
## 1.3     1        3 8129.828 1.155057e+03
## 0.4     0        4 4929.492 9.011426e+02
## 1.4     1        4 5499.224 7.231443e+02
## 0.5     0        5 4373.176 1.072310e+03
## 1.5     1        5 6414.533 8.985061e+02</code></pre>
<p>To obtain the ATE or ATT by pooling stratum-specific effects, svycontrast is used with the weights</p>
<p>First, use ntable to obtain the weights:</p>
<ul>
<li>For estimating the ATE, the stratum weight is wk = nk/n, which is the stratum size divided by the total sample size.</li>
<li>For estimating the ATT, the stratum weight is, wk = n1k/n1 which is the treated sample size within the stratum divided by the total treated sample size.</li>
</ul>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="propensity-score-analysis.html#cb209-1" aria-hidden="true" tabindex="-1"></a>subclass_table <span class="ot">=</span> balance.stratification2<span class="sc">$</span>qn[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb209-2"><a href="propensity-score-analysis.html#cb209-2" aria-hidden="true" tabindex="-1"></a>ATEw <span class="ot">=</span> <span class="fu">colSums</span>(subclass_table)<span class="sc">/</span><span class="fu">sum</span>(subclass_table)</span>
<span id="cb209-3"><a href="propensity-score-analysis.html#cb209-3" aria-hidden="true" tabindex="-1"></a>ATTw <span class="ot">=</span> subclass_table[<span class="dv">2</span>,]<span class="sc">/</span><span class="fu">sum</span>(subclass_table[<span class="dv">2</span>,])</span>
<span id="cb209-4"><a href="propensity-score-analysis.html#cb209-4" aria-hidden="true" tabindex="-1"></a>subclass_table; ATEw; ATTw</span></code></pre></div>
<pre><code>##           1  2  3  4  5
## Control 364 35 14 11  5
## Treated  35 39 37 37 37</code></pre>
<pre><code>##          1          2          3          4          5 
## 0.64983713 0.12052117 0.08306189 0.07817590 0.06840391</code></pre>
<pre><code>##         1         2         3         4         5 
## 0.1891892 0.2108108 0.2000000 0.2000000 0.2000000</code></pre>
<p>This wonâ€™t work:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="propensity-score-analysis.html#cb213-1" aria-hidden="true" tabindex="-1"></a>pooledEffects <span class="ot">&lt;-</span> <span class="fu">svycontrast</span>(subclassMeans, <span class="at">contrasts =</span> <span class="fu">list</span>(<span class="at">ATT=</span>ATTw)) </span></code></pre></div>
<ul>
<li>ATEw and ATTw needs to be specified for EVERY group within EVERY stratum</li>
<li>in our case, 10 groups (2*5 = 10)</li>
<li>Control groups get negative weights and treatment group gets positive weights:</li>
</ul>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="propensity-score-analysis.html#cb214-1" aria-hidden="true" tabindex="-1"></a>subclassMeans<span class="sc">$</span>ATEsw <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span>ATEw[<span class="dv">1</span>], ATEw[<span class="dv">1</span>], <span class="co"># first stratum, </span></span>
<span id="cb214-2"><a href="propensity-score-analysis.html#cb214-2" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">-</span>ATEw[<span class="dv">2</span>], ATEw[<span class="dv">2</span>],  <span class="co"># second stratum</span></span>
<span id="cb214-3"><a href="propensity-score-analysis.html#cb214-3" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">-</span>ATEw[<span class="dv">3</span>], ATEw[<span class="dv">3</span>],  <span class="co"># third stratum</span></span>
<span id="cb214-4"><a href="propensity-score-analysis.html#cb214-4" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">-</span>ATEw[<span class="dv">4</span>], ATEw[<span class="dv">4</span>],  <span class="co"># fourth stratum</span></span>
<span id="cb214-5"><a href="propensity-score-analysis.html#cb214-5" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">-</span>ATEw[<span class="dv">4</span>], ATEw[<span class="dv">5</span>])  <span class="co"># fifth stratum</span></span>
<span id="cb214-6"><a href="propensity-score-analysis.html#cb214-6" aria-hidden="true" tabindex="-1"></a>subclassMeans<span class="sc">$</span>ATTsw <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span>ATTw[<span class="dv">1</span>], ATTw[<span class="dv">1</span>], <span class="co"># first stratum, </span></span>
<span id="cb214-7"><a href="propensity-score-analysis.html#cb214-7" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">-</span>ATTw[<span class="dv">2</span>], ATTw[<span class="dv">2</span>],  <span class="co"># second stratum</span></span>
<span id="cb214-8"><a href="propensity-score-analysis.html#cb214-8" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">-</span>ATTw[<span class="dv">3</span>], ATTw[<span class="dv">3</span>],  <span class="co"># third stratum</span></span>
<span id="cb214-9"><a href="propensity-score-analysis.html#cb214-9" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">-</span>ATTw[<span class="dv">4</span>], ATTw[<span class="dv">4</span>],  <span class="co"># fourth stratum</span></span>
<span id="cb214-10"><a href="propensity-score-analysis.html#cb214-10" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">-</span>ATTw[<span class="dv">4</span>], ATTw[<span class="dv">5</span>])  <span class="co"># fifth stratum</span></span>
<span id="cb214-11"><a href="propensity-score-analysis.html#cb214-11" aria-hidden="true" tabindex="-1"></a>subclassMeans</span></code></pre></div>
<pre><code>##     treat subclass     re78           se       ATEsw      ATTsw
## 0.1     0        1 7274.091 7.071227e+02 -0.64983713 -0.1891892
## 1.1     1        1 6788.463 4.072737e-14  0.64983713  0.1891892
## 0.2     0        2 6493.432 6.533589e+02 -0.12052117 -0.2108108
## 1.2     1        2 9781.223 6.981055e+03  0.12052117  0.2108108
## 0.3     0        3 6258.723 7.261635e+02 -0.08306189 -0.2000000
## 1.3     1        3 8129.828 1.155057e+03  0.08306189  0.2000000
## 0.4     0        4 4929.492 9.011426e+02 -0.07817590 -0.2000000
## 1.4     1        4 5499.224 7.231443e+02  0.07817590  0.2000000
## 0.5     0        5 4373.176 1.072310e+03 -0.07817590 -0.2000000
## 1.5     1        5 6414.533 8.985061e+02  0.06840391  0.2000000</code></pre>
</div>
<div id="estimation-of-treatment-effects" class="section level3 hasAnchor" number="6.4.5">
<h3><span class="header-section-number">6.4.5</span> Estimation of Treatment Effects<a href="propensity-score-analysis.html#estimation-of-treatment-effects" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>view ATTw2 here:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="propensity-score-analysis.html#cb216-1" aria-hidden="true" tabindex="-1"></a>pooledEffects <span class="ot">&lt;-</span> <span class="fu">svycontrast</span>(subclassMeans, </span>
<span id="cb216-2"><a href="propensity-score-analysis.html#cb216-2" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">list</span>(<span class="at">ATE =</span> subclassMeans<span class="sc">$</span>ATTsw, <span class="at">ATT =</span> subclassMeans<span class="sc">$</span>ATEsw)) </span>
<span id="cb216-3"><a href="propensity-score-analysis.html#cb216-3" aria-hidden="true" tabindex="-1"></a>pooledEffects</span></code></pre></div>
<pre><code>##     contrast      SE
## ATE  1497.67 1229.08
## ATT   377.53  787.92</code></pre>
<!------------------------------>
</div>
</div>
<div id="adjustment" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Adjustment<a href="propensity-score-analysis.html#adjustment" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="propensity-score-analysis.html#cb218-1" aria-hidden="true" tabindex="-1"></a>adjustModel <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78<span class="sc">~</span>treat<span class="sc">+</span>pscore,lalonde)</span>
<span id="cb218-2"><a href="propensity-score-analysis.html#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(adjustModel) </span></code></pre></div>
<pre><code>## MODEL INFO:
## Observations: 614
## Dependent Variable: re78
## Type: OLS linear regression 
## 
## MODEL FIT:
## F(2,611) = 4.44, p = 0.01
## RÂ² = 0.01
## Adj. RÂ² = 0.01 
## 
## Standard errors: OLS
## ------------------------------------------------------
##                         Est.      S.E.   t val.      p
## ----------------- ---------- --------- -------- ------
## (Intercept)          7549.86    411.09    18.37   0.00
## treat                1166.40    914.38     1.28   0.20
## pscore              -3678.92   1306.24    -2.82   0.01
## ------------------------------------------------------</code></pre>
<!------------------------------>
</div>
<div id="exercise" class="section level2 hasAnchor" number="6.6">
<h2><span class="header-section-number">6.6</span> Exercise<a href="propensity-score-analysis.html#exercise" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<p>Exercise: can you use fm2 to obtain propensity scores and see if that improves the balance and thus the estimate of treatment effect?</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="psm-matching-strategy.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/YOUR GITHUB USERNAME/YOUR REPO NAME/edit/master/06-PSA.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/YOUR GITHUB USERNAME/YOUR REPO NAME/blob/master/06-PSA.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
