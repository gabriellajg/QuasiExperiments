<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Propensity Score Analysis | R Book for Quasi-Experimental Designs</title>
  <meta name="description" content="Chapter 6 Propensity Score Analysis | R Book for Quasi-Experimental Designs" />
  <meta name="generator" content="bookdown 0.28 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Propensity Score Analysis | R Book for Quasi-Experimental Designs" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Propensity Score Analysis | R Book for Quasi-Experimental Designs" />
  
  
  

<meta name="author" content="Ge Jiang" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="psm-matching-strategy.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R for Quasi-exp Designs</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Course</a></li>
<li class="chapter" data-level="2" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html"><i class="fa fa-check"></i><b>2</b> Regression Approach to Treatment Effect Estimation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html#regression-w-no-confounder"><i class="fa fa-check"></i><b>2.1</b> Regression w/ no confounder</a></li>
<li class="chapter" data-level="2.2" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html#including-confounder-ses"><i class="fa fa-check"></i><b>2.2</b> Including confounder SES</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html#low-ses"><i class="fa fa-check"></i><b>2.2.1</b> low SES</a></li>
<li class="chapter" data-level="2.2.2" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html#middle-ses"><i class="fa fa-check"></i><b>2.2.2</b> middle SES</a></li>
<li class="chapter" data-level="2.2.3" data-path="regression-approach-to-treatment-effect-estimation.html"><a href="regression-approach-to-treatment-effect-estimation.html#high-ses"><i class="fa fa-check"></i><b>2.2.3</b> high SES</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="types-of-causal-effects.html"><a href="types-of-causal-effects.html"><i class="fa fa-check"></i><b>3</b> Types of Causal Effects</a>
<ul>
<li class="chapter" data-level="3.1" data-path="types-of-causal-effects.html"><a href="types-of-causal-effects.html#att-ate-atu-what-the-what"><i class="fa fa-check"></i><b>3.1</b> ATT, ATE, ATU, â€¦ what the what?</a></li>
<li class="chapter" data-level="3.2" data-path="types-of-causal-effects.html"><a href="types-of-causal-effects.html#calculating-different-causal-effects-in-practice"><i class="fa fa-check"></i><b>3.2</b> Calculating different causal effects in practice</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="instrumental-variable.html"><a href="instrumental-variable.html"><i class="fa fa-check"></i><b>4</b> Instrumental Variable</a>
<ul>
<li class="chapter" data-level="4.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#loading-data"><i class="fa fa-check"></i><b>4.1</b> Loading Data</a></li>
<li class="chapter" data-level="4.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#setup"><i class="fa fa-check"></i><b>4.2</b> Setup</a></li>
<li class="chapter" data-level="4.3" data-path="instrumental-variable.html"><a href="instrumental-variable.html#regression-approaches"><i class="fa fa-check"></i><b>4.3</b> Regression Approaches</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#naive-regression-ols-estimate-with-treatment-only"><i class="fa fa-check"></i><b>4.3.1</b> Naive Regression: OLS estimate with treatment only</a></li>
<li class="chapter" data-level="4.3.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#regression-with-covariates"><i class="fa fa-check"></i><b>4.3.2</b> Regression with covariates</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="instrumental-variable.html"><a href="instrumental-variable.html#iv-does-education-effect-wages-when-college-proximity-is-used-as-the-instrument"><i class="fa fa-check"></i><b>4.4</b> IV: Does education effect wages when college proximity is used as the instrument?</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#stage-1-t-on-iv"><i class="fa fa-check"></i><b>4.4.1</b> Stage 1: T on IV</a></li>
<li class="chapter" data-level="4.4.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#stage-2-y-on-t_hat"><i class="fa fa-check"></i><b>4.4.2</b> Stage 2: Y on T_hat</a></li>
<li class="chapter" data-level="4.4.3" data-path="instrumental-variable.html"><a href="instrumental-variable.html#all-in-one-function-ivreg"><i class="fa fa-check"></i><b>4.4.3</b> All-in-one function ivreg():</a></li>
<li class="chapter" data-level="4.4.4" data-path="instrumental-variable.html"><a href="instrumental-variable.html#diagnostic-tests"><i class="fa fa-check"></i><b>4.4.4</b> Diagnostic tests:</a></li>
<li class="chapter" data-level="4.4.5" data-path="instrumental-variable.html"><a href="instrumental-variable.html#multiple-iv"><i class="fa fa-check"></i><b>4.4.5</b> Multiple IV</a></li>
<li class="chapter" data-level="4.4.6" data-path="instrumental-variable.html"><a href="instrumental-variable.html#compare-with-ols"><i class="fa fa-check"></i><b>4.4.6</b> Compare with OLS:</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="instrumental-variable.html"><a href="instrumental-variable.html#take-home-exercise"><i class="fa fa-check"></i><b>4.5</b> Take-home exercise</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="instrumental-variable.html"><a href="instrumental-variable.html#does-cigarette-smoking-have-an-effect-on-child-birth-weight-wooldridge-2002"><i class="fa fa-check"></i><b>4.5.1</b> Does cigarette smoking have an effect on child birth weight (Wooldridge, 2002)?</a></li>
<li class="chapter" data-level="4.5.2" data-path="instrumental-variable.html"><a href="instrumental-variable.html#missing-data"><i class="fa fa-check"></i><b>4.5.2</b> Missing data</a></li>
<li class="chapter" data-level="4.5.3" data-path="instrumental-variable.html"><a href="instrumental-variable.html#your-turn-now"><i class="fa fa-check"></i><b>4.5.3</b> Your turn now!!!!</a></li>
<li class="chapter" data-level="4.5.4" data-path="instrumental-variable.html"><a href="instrumental-variable.html#naive-regression-ols-estimate-with-treatment-only-1"><i class="fa fa-check"></i><b>4.5.4</b> Naive Regression: OLS Estimate with treatment only</a></li>
<li class="chapter" data-level="4.5.5" data-path="instrumental-variable.html"><a href="instrumental-variable.html#regression-with-covariates-1"><i class="fa fa-check"></i><b>4.5.5</b> Regression with covariates</a></li>
<li class="chapter" data-level="4.5.6" data-path="instrumental-variable.html"><a href="instrumental-variable.html#iv-done-manually"><i class="fa fa-check"></i><b>4.5.6</b> IV done manually</a></li>
<li class="chapter" data-level="4.5.7" data-path="instrumental-variable.html"><a href="instrumental-variable.html#ivreg"><i class="fa fa-check"></i><b>4.5.7</b> IVreg()</a></li>
<li class="chapter" data-level="4.5.8" data-path="instrumental-variable.html"><a href="instrumental-variable.html#model-comparison"><i class="fa fa-check"></i><b>4.5.8</b> Model Comparison</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html"><i class="fa fa-check"></i><b>5</b> PSM Matching Strategy</a>
<ul>
<li class="chapter" data-level="5.1" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#data"><i class="fa fa-check"></i><b>5.1</b> Data</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#create-dummy-variable-for-race-and-unemployment"><i class="fa fa-check"></i><b>5.1.1</b> Create dummy variable for race and unemployment</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#regression-estimates"><i class="fa fa-check"></i><b>5.2</b> Regression Estimates</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#naive-t-test-estimate"><i class="fa fa-check"></i><b>5.2.1</b> naive t-test estimate</a></li>
<li class="chapter" data-level="5.2.2" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#regression-with-covariates-2"><i class="fa fa-check"></i><b>5.2.2</b> regression with covariates</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#psm-steps"><i class="fa fa-check"></i><b>5.3</b> PSM Steps</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#selection-of-covariates-in-x"><i class="fa fa-check"></i><b>5.3.1</b> Selection of covariates in X</a></li>
<li class="chapter" data-level="5.3.2" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#calculation-of-propensity-scores-p-scores"><i class="fa fa-check"></i><b>5.3.2</b> Calculation of propensity scores (p-scores)</a></li>
<li class="chapter" data-level="5.3.3" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#matching-based-on-p-sores"><i class="fa fa-check"></i><b>5.3.3</b> Matching based on p-sores</a></li>
<li class="chapter" data-level="5.3.4" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#checking-balance-on-covariates"><i class="fa fa-check"></i><b>5.3.4</b> Checking balance on covariates:</a></li>
<li class="chapter" data-level="5.3.5" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#estimation-of-treatment-effect"><i class="fa fa-check"></i><b>5.3.5</b> Estimation of treatment effect</a></li>
<li class="chapter" data-level="5.3.6" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#hidden-bias-analysis"><i class="fa fa-check"></i><b>5.3.6</b> Hidden bias analysis</a></li>
<li class="chapter" data-level="5.3.7" data-path="psm-matching-strategy.html"><a href="psm-matching-strategy.html#references"><i class="fa fa-check"></i><b>5.3.7</b> References:</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html"><i class="fa fa-check"></i><b>6</b> Propensity Score Analysis</a>
<ul>
<li class="chapter" data-level="6.1" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#data-1"><i class="fa fa-check"></i><b>6.1</b> Data</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#create-dummy-variable-for-race-and-unemployment-1"><i class="fa fa-check"></i><b>6.1.1</b> Create dummy variable for race and unemployment</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#calculating-propensity-scores"><i class="fa fa-check"></i><b>6.2</b> Calculating Propensity Scores</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#different-formulas"><i class="fa fa-check"></i><b>6.2.1</b> Different formulas</a></li>
<li class="chapter" data-level="6.2.2" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#calculation-of-propensity-scores-p-scores-1"><i class="fa fa-check"></i><b>6.2.2</b> Calculation of propensity scores (p-scores)</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#iptw-inverse-probability-treatment-weighting"><i class="fa fa-check"></i><b>6.3</b> IPTW: Inverse Probability Treatment Weighting</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#balance-check"><i class="fa fa-check"></i><b>6.3.1</b> Balance check</a></li>
<li class="chapter" data-level="6.3.2" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#estimation-of-treatment-effect-1"><i class="fa fa-check"></i><b>6.3.2</b> Estimation of treatment effect</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#stratification"><i class="fa fa-check"></i><b>6.4</b> Stratification</a></li>
<li class="chapter" data-level="6.5" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#adjustment"><i class="fa fa-check"></i><b>6.5</b> Adjustment</a></li>
<li class="chapter" data-level="6.6" data-path="propensity-score-analysis.html"><a href="propensity-score-analysis.html#exercise"><i class="fa fa-check"></i><b>6.6</b> Exercise</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R Book for Quasi-Experimental Designs</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="propensity-score-analysis" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Chapter 6</span> Propensity Score Analysis<a href="propensity-score-analysis.html#propensity-score-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this lab, we will use propensity scores to perform other types of analyses (weighting, stratification, and covariate adjustment)</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="propensity-score-analysis.html#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(weights)</span>
<span id="cb148-2"><a href="propensity-score-analysis.html#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span>
<span id="cb148-3"><a href="propensity-score-analysis.html#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(twang)</span>
<span id="cb148-4"><a href="propensity-score-analysis.html#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CBPS)</span>
<span id="cb148-5"><a href="propensity-score-analysis.html#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cobalt)</span>
<span id="cb148-6"><a href="propensity-score-analysis.html#cb148-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jtools)</span>
<span id="cb148-7"><a href="propensity-score-analysis.html#cb148-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb148-8"><a href="propensity-score-analysis.html#cb148-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich) <span class="co">#vcovCL</span></span>
<span id="cb148-9"><a href="propensity-score-analysis.html#cb148-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rbounds) <span class="co">#gamma</span></span>
<span id="cb148-10"><a href="propensity-score-analysis.html#cb148-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb148-11"><a href="propensity-score-analysis.html#cb148-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb148-12"><a href="propensity-score-analysis.html#cb148-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span></code></pre></div>
<!------------------------------>
<div id="data-1" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Data<a href="propensity-score-analysis.html#data-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="propensity-score-analysis.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co">#data(lalonde)</span></span>
<span id="cb149-2"><a href="propensity-score-analysis.html#cb149-2" aria-hidden="true" tabindex="-1"></a>lalonde <span class="ot">=</span> MatchIt<span class="sc">::</span>lalonde</span>
<span id="cb149-3"><a href="propensity-score-analysis.html#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(lalonde)</span></code></pre></div>
<pre><code>## [1] 614   9</code></pre>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="propensity-score-analysis.html#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(lalonde)</span></code></pre></div>
<pre><code>## [1] &quot;treat&quot;    &quot;age&quot;      &quot;educ&quot;     &quot;race&quot;     &quot;married&quot;  &quot;nodegree&quot; &quot;re74&quot;     &quot;re75&quot;    
## [9] &quot;re78&quot;</code></pre>
<div id="create-dummy-variable-for-race-and-unemployment-1" class="section level3 hasAnchor" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Create dummy variable for race and unemployment<a href="propensity-score-analysis.html#create-dummy-variable-for-race-and-unemployment-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="propensity-score-analysis.html#cb153-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>black <span class="ot">=</span> <span class="fu">ifelse</span>(lalonde<span class="sc">$</span>race<span class="sc">==</span><span class="st">&#39;black&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb153-2"><a href="propensity-score-analysis.html#cb153-2" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>hispan <span class="ot">=</span> <span class="fu">ifelse</span>(lalonde<span class="sc">$</span>race<span class="sc">==</span><span class="st">&#39;hispan&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb153-3"><a href="propensity-score-analysis.html#cb153-3" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>un74 <span class="ot">=</span> <span class="fu">ifelse</span>(lalonde<span class="sc">$</span>re74<span class="sc">==</span><span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb153-4"><a href="propensity-score-analysis.html#cb153-4" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>un75 <span class="ot">=</span> <span class="fu">ifelse</span>(lalonde<span class="sc">$</span>re75<span class="sc">==</span><span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span></code></pre></div>
<!------------------------------>
</div>
</div>
<div id="calculating-propensity-scores" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Calculating Propensity Scores<a href="propensity-score-analysis.html#calculating-propensity-scores" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<div id="different-formulas" class="section level3 hasAnchor" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Different formulas<a href="propensity-score-analysis.html#different-formulas" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="propensity-score-analysis.html#cb154-1" aria-hidden="true" tabindex="-1"></a>fm1 <span class="ot">=</span> treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispan <span class="sc">+</span> married <span class="sc">+</span> <span class="fu">I</span>(re74<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">+</span> <span class="fu">I</span>(re75<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb154-2"><a href="propensity-score-analysis.html#cb154-2" aria-hidden="true" tabindex="-1"></a>fm2 <span class="ot">=</span> treat <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispan <span class="sc">+</span> married <span class="sc">+</span> <span class="fu">I</span>(re74<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">+</span> <span class="fu">I</span>(re75<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb154-3"><a href="propensity-score-analysis.html#cb154-3" aria-hidden="true" tabindex="-1"></a>fm3 <span class="ot">=</span> treat <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(age<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> educ <span class="sc">+</span> <span class="fu">I</span>(educ<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> black <span class="sc">+</span> hispan <span class="sc">+</span> married <span class="sc">+</span> <span class="fu">I</span>(re74<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">+</span> <span class="fu">I</span>(re75<span class="sc">/</span><span class="dv">1000</span>)</span></code></pre></div>
</div>
<div id="calculation-of-propensity-scores-p-scores-1" class="section level3 hasAnchor" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Calculation of propensity scores (p-scores)<a href="propensity-score-analysis.html#calculation-of-propensity-scores-p-scores-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="propensity-score-analysis.html#cb155-1" aria-hidden="true" tabindex="-1"></a>pscore <span class="ot">&lt;-</span> <span class="fu">glm</span>(fm2, <span class="at">data =</span> lalonde, <span class="at">family =</span> <span class="st">&#39;binomial&#39;</span>)</span>
<span id="cb155-2"><a href="propensity-score-analysis.html#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pscore<span class="sc">$</span>fitted.values)</span></code></pre></div>
<pre><code>##      NSW1      NSW2      NSW3      NSW4      NSW5      NSW6 
## 0.5871794 0.3014102 0.9056376 0.9020139 0.9069395 0.8230760</code></pre>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="propensity-score-analysis.html#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(pscore<span class="sc">$</span>fitted.values[lalonde<span class="sc">$</span>treat<span class="sc">==</span><span class="dv">0</span>],<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-72-1.png" width="672" /></p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="propensity-score-analysis.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(pscore<span class="sc">$</span>fitted.values[lalonde<span class="sc">$</span>treat<span class="sc">==</span><span class="dv">1</span>],<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-72-2.png" width="672" /></p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="propensity-score-analysis.html#cb159-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>pscore <span class="ot">=</span> pscore<span class="sc">$</span>fitted.values</span></code></pre></div>
<!------------------------------>
</div>
</div>
<div id="iptw-inverse-probability-treatment-weighting" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> IPTW: Inverse Probability Treatment Weighting<a href="propensity-score-analysis.html#iptw-inverse-probability-treatment-weighting" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<p>In the following code, the weight variable weightATE is created by using the ifelse() function to obtain the inverse of the propensity score for treated units or the inverse of 1 minus the propensity score for control units</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="propensity-score-analysis.html#cb160-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>weightATE <span class="ot">&lt;-</span> <span class="fu">with</span>(lalonde, <span class="fu">ifelse</span>(treat<span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>pscore, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pscore)))</span></code></pre></div>
<p>A summary of the ATE weights for treated and untreated groups is obtained with the following:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="propensity-score-analysis.html#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(lalonde, <span class="fu">by</span>(weightATE,treat,summary)) </span></code></pre></div>
<pre><code>## treat: 0
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.000   1.026   1.067   1.441   1.233  10.579 
## ------------------------------------------------------------------------ 
## treat: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.076   1.155   1.510   2.907   2.123  33.961</code></pre>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="propensity-score-analysis.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(lalonde<span class="sc">$</span>weightATE <span class="sc">~</span> lalonde<span class="sc">$</span>treat)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-74-1.png" width="672" /></p>
<ul>
<li><p>the maximum weight for the ATE is 117.417</p></li>
<li><p>Individuals with extreme weights for the ATE are those who are either very likely to participate in the treatment given their covariate values but did not or very unlikely to participate but did so.</p></li>
<li><p>perform weight truncation</p></li>
<li><p>Truncation can be performed by assigning the weight at a cutoff percentile to observations with weights above the cutoff.</p></li>
<li><p>The following code demonstrates weight truncation. More specifically, it uses the quantile function to calculate the weight at the 99th percentile and the ifelse function to assign this weight to any student whose weight exceeds the 99th percentile:</p></li>
</ul>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="propensity-score-analysis.html#cb164-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>weightATETruncated <span class="ot">&lt;-</span> <span class="fu">with</span>(lalonde, <span class="fu">ifelse</span>(weightATE <span class="sc">&gt;</span> <span class="fu">quantile</span>(weightATE, <span class="fl">0.99</span>), <span class="fu">quantile</span>(weightATE, <span class="fl">0.99</span>), weightATE))</span></code></pre></div>
<p>may truncate all above .05 quantiles if necessary</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="propensity-score-analysis.html#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(lalonde, <span class="fu">by</span>(weightATETruncated,treat,summary)) </span></code></pre></div>
<pre><code>## treat: 0
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.000   1.026   1.067   1.441   1.233  10.579 
## ------------------------------------------------------------------------ 
## treat: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.076   1.155   1.510   2.530   2.123  12.546</code></pre>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="propensity-score-analysis.html#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(lalonde<span class="sc">$</span>weightATETruncated <span class="sc">~</span> lalonde<span class="sc">$</span>treat)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-76-1.png" width="672" /></p>
<div id="balance-check" class="section level3 hasAnchor" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> Balance check<a href="propensity-score-analysis.html#balance-check" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In this section, covariate balance evaluation is performed by comparing the standardized difference between the weighted means of the treated and untreated groups.</p>
<p>The bal.stat function of the twang package (Ridgeway et al., 2013) is useful for covariate balance evaluation.</p>
<p>If there are no sampling weights, then sampw=1.</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="propensity-score-analysis.html#cb168-1" aria-hidden="true" tabindex="-1"></a>covariateNames <span class="ot">&lt;-</span><span class="fu">names</span>(lalonde)[<span class="dv">3</span><span class="sc">:</span><span class="dv">14</span>]</span>
<span id="cb168-2"><a href="propensity-score-analysis.html#cb168-2" aria-hidden="true" tabindex="-1"></a>balanceTable <span class="ot">&lt;-</span> <span class="fu">bal.stat</span>(lalonde, <span class="at">vars=</span> covariateNames,</span>
<span id="cb168-3"><a href="propensity-score-analysis.html#cb168-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">treat.var =</span> <span class="st">&quot;treat&quot;</span>,</span>
<span id="cb168-4"><a href="propensity-score-analysis.html#cb168-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">w.all =</span> lalonde<span class="sc">$</span>weightATETruncated, </span>
<span id="cb168-5"><a href="propensity-score-analysis.html#cb168-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">get.ks=</span>F,</span>
<span id="cb168-6"><a href="propensity-score-analysis.html#cb168-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">sampw =</span> <span class="dv">1</span>,</span>
<span id="cb168-7"><a href="propensity-score-analysis.html#cb168-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">estimand=</span><span class="st">&quot;ATE&quot;</span>, <span class="at">multinom=</span>F)</span>
<span id="cb168-8"><a href="propensity-score-analysis.html#cb168-8" aria-hidden="true" tabindex="-1"></a>balanceTable <span class="ot">&lt;-</span> balanceTable<span class="sc">$</span>results</span>
<span id="cb168-9"><a href="propensity-score-analysis.html#cb168-9" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(balanceTable,<span class="dv">3</span>) </span></code></pre></div>
<pre><code>##                tx.mn    tx.sd    ct.mn    ct.sd std.eff.sz   stat     p
## educ          10.460    2.012   10.258    3.002      0.077  0.654 0.513
## race:black     0.531    0.499    0.401    0.490      0.267  3.275 0.039
## race:hispan    0.163    0.370    0.117    0.322      0.144     NA    NA
## race:white     0.305    0.461    0.482    0.500     -0.354     NA    NA
## married        0.292    0.456    0.408    0.492     -0.236 -1.857 0.064
## nodegree       0.659    0.475    0.573    0.495      0.178  1.374 0.170
## re74        3258.732 6878.773 4513.602 6295.593     -0.194 -1.226 0.221
## re75        1997.046 3474.214 2137.977 3144.448     -0.043 -0.327 0.744
## re78        7169.346 7942.905 6349.181 6943.242      0.110  0.792 0.429
## black          0.531    0.500    0.401    0.491      0.267  1.957 0.051
## hispan         0.163    0.371    0.117    0.322      0.144  0.862 0.389
## un74           0.386    0.488    0.677    0.468     -0.594 -4.450 0.000
## un75           0.498    0.501    0.623    0.485     -0.255 -1.953 0.051
## pscore         0.390    0.308    0.306    0.316      0.268  1.938 0.053</code></pre>
<ul>
<li>std.eff.sz quantifies effect size</li>
<li>0.2 small 0.5 medium 0.8 large</li>
<li>most of them are medium to large - balance was not achieved *</li>
</ul>
</div>
<div id="estimation-of-treatment-effect-1" class="section level3 hasAnchor" number="6.3.2">
<h3><span class="header-section-number">6.3.2</span> Estimation of treatment effect<a href="propensity-score-analysis.html#estimation-of-treatment-effect-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>the final weights are divided by the mean of weights to make them sum to the sample size, which is a process known as normalization.</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="propensity-score-analysis.html#cb170-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>finalWeight <span class="ot">&lt;-</span> lalonde<span class="sc">$</span>weightATETruncated<span class="sc">/</span><span class="fu">mean</span>(lalonde<span class="sc">$</span>weightATETruncated)</span></code></pre></div>
<p>Before the estimation can be performed, the surveyDesign object is created with the svydesign function to declare the names of the variables that contain cluster ids, strata ids, weights, and the data set:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="propensity-score-analysis.html#cb171-1" aria-hidden="true" tabindex="-1"></a>surveyDesign <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>finalWeight, <span class="at">data =</span> lalonde, <span class="at">nest=</span>T) </span></code></pre></div>
<p>Methods to obtain standard errors for propensity score weighted estimates include Taylor series linearization and resampling methods such as bootstrapping, jackknife, and balanced repeated replication (see review by Rodgers, 1999).</p>
<p>To use bootstrap methods with the survey package, the surveyDesign object created above should be modified to include weights for each replication. The following code takes the surveyDesign object and adds weights for 1,000 bootstrapped samples:</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="propensity-score-analysis.html#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">8</span>)</span>
<span id="cb172-2"><a href="propensity-score-analysis.html#cb172-2" aria-hidden="true" tabindex="-1"></a>surveyDesignBoot <span class="ot">&lt;-</span> <span class="fu">as.svrepdesign</span>(surveyDesign, <span class="at">type=</span><span class="fu">c</span>(<span class="st">&quot;bootstrap&quot;</span>), <span class="at">replicates=</span><span class="dv">1000</span>)</span></code></pre></div>
<p>First, the svyby function is used to apply the svymean function separately to treated and control units to obtain weighted outcome:</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="propensity-score-analysis.html#cb173-1" aria-hidden="true" tabindex="-1"></a>weightedMeans <span class="ot">&lt;-</span> <span class="fu">svyby</span>(<span class="at">formula=</span><span class="sc">~</span>re78, <span class="at">by=</span><span class="sc">~</span>treat, <span class="at">design=</span>surveyDesignBoot, <span class="at">FUN=</span>svymean, <span class="at">covmat=</span><span class="cn">TRUE</span>)</span>
<span id="cb173-2"><a href="propensity-score-analysis.html#cb173-2" aria-hidden="true" tabindex="-1"></a>weightedMeans</span></code></pre></div>
<pre><code>##   treat     re78       se
## 0     0 6349.181 394.5367
## 1     1 7169.346 956.6697</code></pre>
<p><em>The code to obtain the treatment effect with a regression model is shown as follows.
</em> The model formula using R notation is re78~treat. This formula can be expanded to include any covariates and interaction effects of interest</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="propensity-score-analysis.html#cb175-1" aria-hidden="true" tabindex="-1"></a>outcomeModel <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(re78<span class="sc">~</span>treat,surveyDesignBoot)</span>
<span id="cb175-2"><a href="propensity-score-analysis.html#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(outcomeModel) <span class="co"># final model</span></span></code></pre></div>
<pre><code>## 
## Call:
## svyglm(formula = re78 ~ treat, surveyDesignBoot)
## 
## Survey design:
## as.svrepdesign.default(surveyDesign, type = c(&quot;bootstrap&quot;), replicates = 1000)
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   6349.2      394.5   16.09   &lt;2e-16 ***
## treat          820.2     1025.7    0.80    0.424    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for gaussian family taken to be 33407668806)
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<!------------------------------>
</div>
</div>
<div id="stratification" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Stratification<a href="propensity-score-analysis.html#stratification" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<ul>
<li>The following code used the cut function to create five strata of approximately the same size based on the quintiles of the distribution of propensity scores for both treated and untreated groups.</li>
<li>The quintiles are obtained with the quantile function. The function levels is used to assign number labels from 1 to 5 to the strata, and then xtabs is used to display strata by treatment counts.</li>
</ul>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="propensity-score-analysis.html#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(lalonde<span class="sc">$</span>pscore)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-83-1.png" width="672" /></p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="propensity-score-analysis.html#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(lalonde<span class="sc">$</span>pscore, <span class="at">prob =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span>))</span></code></pre></div>
<pre><code>##           0%          20%          40%          60%          80%         100% 
## 0.0004734592 0.0298866776 0.0730729257 0.2744818790 0.6466930310 0.9295361003</code></pre>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="propensity-score-analysis.html#cb180-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>subclass <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="at">x=</span>lalonde<span class="sc">$</span>pscore, <span class="at">breaks =</span> <span class="fu">quantile</span>(lalonde<span class="sc">$</span>pscore, <span class="at">prob =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span>)), <span class="at">include.lowest=</span>T)</span>
<span id="cb180-2"><a href="propensity-score-analysis.html#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(lalonde<span class="sc">$</span>subclass) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">levels</span>(lalonde<span class="sc">$</span>subclass))</span>
<span id="cb180-3"><a href="propensity-score-analysis.html#cb180-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-4"><a href="propensity-score-analysis.html#cb180-4" aria-hidden="true" tabindex="-1"></a>ntable <span class="ot">&lt;-</span> <span class="fu">xtabs</span>(<span class="sc">~</span>treat<span class="sc">+</span>subclass,lalonde) </span>
<span id="cb180-5"><a href="propensity-score-analysis.html#cb180-5" aria-hidden="true" tabindex="-1"></a>ntable</span></code></pre></div>
<pre><code>##      subclass
## treat   1   2   3   4   5
##     0 122 119 103  61  24
##     1   1   4  19  62  99</code></pre>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="propensity-score-analysis.html#cb182-1" aria-hidden="true" tabindex="-1"></a>surveyDesign <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>finalWeight, <span class="at">data =</span> lalonde, <span class="at">nest=</span>T) </span></code></pre></div>
<p>To use bootstrap methods with the survey package, the surveyDesign object created above should be modified to include weights for each replication. The following code takes the surveyDesign object and adds weights for 1,000 bootstrapped samples:</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="propensity-score-analysis.html#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">8</span>)</span>
<span id="cb183-2"><a href="propensity-score-analysis.html#cb183-2" aria-hidden="true" tabindex="-1"></a>surveyDesignBoot <span class="ot">&lt;-</span> <span class="fu">as.svrepdesign</span>(surveyDesign, <span class="at">type=</span><span class="fu">c</span>(<span class="st">&quot;bootstrap&quot;</span>), <span class="at">replicates=</span><span class="dv">1000</span>) </span></code></pre></div>
<p>The following R code uses svyby to apply the svymean function:</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="propensity-score-analysis.html#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(lalonde)</span></code></pre></div>
<pre><code>##      treat age educ   race married nodegree re74 re75       re78 black hispan un74 un75
## NSW1     1  37   11  black       1        1    0    0  9930.0460     1      0    0    0
## NSW2     1  22    9 hispan       0        1    0    0  3595.8940     0      1    0    0
## NSW3     1  30   12  black       0        0    0    0 24909.4500     1      0    0    0
## NSW4     1  27   11  black       0        1    0    0  7506.1460     1      0    0    0
## NSW5     1  33    8  black       0        1    0    0   289.7899     1      0    0    0
## NSW6     1  22    9  black       0        1    0    0  4056.4940     1      0    0    0
##         pscore weightATE weightATETruncated finalWeight subclass
## NSW1 0.5871794  1.703057           1.703057   0.9625366        4
## NSW2 0.3014102  3.317738           3.317738   1.8751250        4
## NSW3 0.9056376  1.104194           1.104194   0.6240705        5
## NSW4 0.9020139  1.108630           1.108630   0.6265776        5
## NSW5 0.9069395  1.102609           1.102609   0.6231747        5
## NSW6 0.8230760  1.214955           1.214955   0.6866701        5</code></pre>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="propensity-score-analysis.html#cb186-1" aria-hidden="true" tabindex="-1"></a>subclassMeans <span class="ot">&lt;-</span> <span class="fu">svyby</span>(<span class="at">formula=</span><span class="sc">~</span>re78, <span class="at">by=</span><span class="sc">~</span>treat<span class="sc">+</span>subclass,</span>
<span id="cb186-2"><a href="propensity-score-analysis.html#cb186-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">design=</span>surveyDesignBoot, <span class="at">FUN=</span>svymean, <span class="at">covmat=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## Warning in svrVar(repmeans, scale, rscales, mse = design$mse, coef = rval): 350 replicates gave
## NA results and were discarded.</code></pre>
<pre><code>## Warning in svrVar(repmeans, scale, rscales, mse = design$mse, coef = rval): 21 replicates gave NA
## results and were discarded.</code></pre>
<pre><code>## Warning in svrVar(replicates, design$scale, design$rscales, mse = design$mse, : 360 replicates
## gave NA results and were discarded.</code></pre>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="propensity-score-analysis.html#cb190-1" aria-hidden="true" tabindex="-1"></a>subclassMeans</span></code></pre></div>
<pre><code>##     treat subclass      re78           se
## 0.1     0        1  8774.975 7.401116e+02
## 1.1     1        1  6788.463 4.072737e-14
## 0.2     0        2  7333.718 7.000384e+02
## 1.2     1        2  3330.084 1.245754e+03
## 0.3     0        3  6213.953 6.240724e+02
## 1.3     1        3 10249.964 2.443014e+03
## 0.4     0        4  4601.847 7.941464e+02
## 1.4     1        4  5616.417 6.939908e+02
## 0.5     0        5  4819.586 1.158452e+03
## 1.5     1        5  6501.883 8.881021e+02</code></pre>
<p>To obtain the ATE or ATT by pooling stratum-specific effects, svycontrast is used with the weights</p>
<p>First, use ntable to obtain the weights</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="propensity-score-analysis.html#cb192-1" aria-hidden="true" tabindex="-1"></a>ntable</span></code></pre></div>
<pre><code>##      subclass
## treat   1   2   3   4   5
##     0 122 119 103  61  24
##     1   1   4  19  62  99</code></pre>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="propensity-score-analysis.html#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(ntable)<span class="sc">/</span><span class="fu">sum</span>(ntable)</span></code></pre></div>
<pre><code>##         1         2         3         4         5 
## 0.2003257 0.2003257 0.1986971 0.2003257 0.2003257</code></pre>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="propensity-score-analysis.html#cb196-1" aria-hidden="true" tabindex="-1"></a>ATTw <span class="ot">=</span> <span class="fu">colSums</span>(ntable)<span class="sc">/</span><span class="fu">sum</span>(ntable)</span></code></pre></div>
<p>This wonâ€™t work:</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="propensity-score-analysis.html#cb197-1" aria-hidden="true" tabindex="-1"></a>pooledEffects <span class="ot">&lt;-</span> <span class="fu">svycontrast</span>(subclassMeans, <span class="at">contrasts =</span> <span class="fu">list</span>(<span class="at">ATT=</span>ATTw)) </span></code></pre></div>
<ul>
<li>ATTw needs to be specified for EVERY group within EVERY stratum</li>
<li>in our case, 9 groups (no treatment in first stratum so 2*5-1 = 9)</li>
<li>Control groups get negative weights and treatment group gets positive weights:</li>
</ul>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="propensity-score-analysis.html#cb198-1" aria-hidden="true" tabindex="-1"></a>ATTw2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span>ATTw[<span class="dv">1</span>], ATTw[<span class="dv">1</span>], <span class="co"># first stratum, just control</span></span>
<span id="cb198-2"><a href="propensity-score-analysis.html#cb198-2" aria-hidden="true" tabindex="-1"></a>           <span class="sc">-</span>ATTw[<span class="dv">2</span>], ATTw[<span class="dv">2</span>],  <span class="co"># second stratum</span></span>
<span id="cb198-3"><a href="propensity-score-analysis.html#cb198-3" aria-hidden="true" tabindex="-1"></a>           <span class="sc">-</span>ATTw[<span class="dv">3</span>], ATTw[<span class="dv">3</span>],  <span class="co"># third stratum</span></span>
<span id="cb198-4"><a href="propensity-score-analysis.html#cb198-4" aria-hidden="true" tabindex="-1"></a>           <span class="sc">-</span>ATTw[<span class="dv">4</span>], ATTw[<span class="dv">4</span>],  <span class="co"># fourth stratum</span></span>
<span id="cb198-5"><a href="propensity-score-analysis.html#cb198-5" aria-hidden="true" tabindex="-1"></a>           <span class="sc">-</span>ATTw[<span class="dv">4</span>], ATTw[<span class="dv">5</span>])  <span class="co"># fifth stratum</span></span>
<span id="cb198-6"><a href="propensity-score-analysis.html#cb198-6" aria-hidden="true" tabindex="-1"></a>subclassMeans<span class="sc">$</span>ATTw2 <span class="ot">&lt;-</span> ATTw2</span></code></pre></div>
<p>view ATTw2 here:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="propensity-score-analysis.html#cb199-1" aria-hidden="true" tabindex="-1"></a>subclassMeans</span></code></pre></div>
<pre><code>##     treat subclass      re78           se      ATTw2
## 0.1     0        1  8774.975 7.401116e+02 -0.2003257
## 1.1     1        1  6788.463 4.072737e-14  0.2003257
## 0.2     0        2  7333.718 7.000384e+02 -0.2003257
## 1.2     1        2  3330.084 1.245754e+03  0.2003257
## 0.3     0        3  6213.953 6.240724e+02 -0.1986971
## 1.3     1        3 10249.964 2.443014e+03  0.1986971
## 0.4     0        4  4601.847 7.941464e+02 -0.2003257
## 1.4     1        4  5616.417 6.939908e+02  0.2003257
## 0.5     0        5  4819.586 1.158452e+03 -0.2003257
## 1.5     1        5  6501.883 8.881021e+02  0.2003257</code></pre>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="propensity-score-analysis.html#cb201-1" aria-hidden="true" tabindex="-1"></a>pooledEffects <span class="ot">&lt;-</span> <span class="fu">svycontrast</span>(subclassMeans, <span class="fu">list</span>(<span class="at">ATT=</span><span class="fu">as.numeric</span>(ATTw2))) </span>
<span id="cb201-2"><a href="propensity-score-analysis.html#cb201-2" aria-hidden="true" tabindex="-1"></a>pooledEffects</span></code></pre></div>
<pre><code>##     contrast    SE
## ATT   142.22 557.7</code></pre>
<!------------------------------>
</div>
<div id="adjustment" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Adjustment<a href="propensity-score-analysis.html#adjustment" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="propensity-score-analysis.html#cb203-1" aria-hidden="true" tabindex="-1"></a>adjustModel <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78<span class="sc">~</span>treat<span class="sc">+</span>pscore,lalonde)</span>
<span id="cb203-2"><a href="propensity-score-analysis.html#cb203-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(adjustModel) </span></code></pre></div>
<pre><code>## MODEL INFO:
## Observations: 614
## Dependent Variable: re78
## Type: OLS linear regression 
## 
## MODEL FIT:
## F(2,611) = 4.29, p = 0.01
## RÂ² = 0.01
## Adj. RÂ² = 0.01 
## 
## Standard errors: OLS
## ------------------------------------------------------
##                         Est.      S.E.   t val.      p
## ----------------- ---------- --------- -------- ------
## (Intercept)          7569.64    416.59    18.17   0.00
## treat                1029.49    888.59     1.16   0.25
## pscore              -3607.64   1304.77    -2.76   0.01
## ------------------------------------------------------</code></pre>
<!------------------------------>
</div>
<div id="exercise" class="section level2 hasAnchor" number="6.6">
<h2><span class="header-section-number">6.6</span> Exercise<a href="propensity-score-analysis.html#exercise" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!------------------------------>
<p>Exercise: can you use fm2 to obtain propensity scores and see if that improves the balance and thus the estimate of treatment effect?</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="psm-matching-strategy.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/YOUR GITHUB USERNAME/YOUR REPO NAME/edit/master/06-PSA.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/YOUR GITHUB USERNAME/YOUR REPO NAME/blob/master/06-PSA.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
